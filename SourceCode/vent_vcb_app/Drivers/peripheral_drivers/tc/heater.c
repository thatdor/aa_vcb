/*
 * heater.c
 *
 *  Created on: Apr 15, 2024
 *      Author: dawei.zhou
 */
#include "main.h"
#include "cmsis_os.h"
#include "heater.h"

// 获取pt100温度
float heater_pt100_get_temperature_by_map(float resistance, float tmp_map_tbl[][2], uint32_t count)
{
    //int count = sizeof(tmp_map_tbl)/sizeof(tmp_map_tbl[0]);
    int low = 0;
    int high = count - 1;
    int mid = 0;
    float tmp = 0;

    if (resistance < tmp_map_tbl[0][0])
    {
        tmp = tmp_map_tbl[0][1] * 10;
    }
    else if (resistance > tmp_map_tbl[count-1][0])
    {
        tmp = tmp_map_tbl[count-1][1] * 10;
    }
    else
    {
        while(low <= high)
        {
            mid = (low + high) / 2;
            if (resistance > tmp_map_tbl[mid][0])
            {
                if (resistance < tmp_map_tbl[mid+1][0])
                {
                    tmp = tmp_map_tbl[mid][1] * 10 +
                            ((resistance - tmp_map_tbl[mid][0]) * 10) /
                            (tmp_map_tbl[mid+1][0] - tmp_map_tbl[mid][0]) *
                            (tmp_map_tbl[mid][1] - tmp_map_tbl[mid + 1][1])
                            ;
                    break;
                }
                low = mid + 1;
            }
            else if (resistance < tmp_map_tbl[mid][0])
            {
                if (resistance > tmp_map_tbl[mid-1][0])
                {
                    tmp = tmp_map_tbl[mid - 1][1] * 10 +
                                                ((tmp_map_tbl[mid - 1][0] - resistance) * 10) /
                                                (tmp_map_tbl[mid][0] - tmp_map_tbl[mid-1][0]) *
                                                (tmp_map_tbl[mid - 1][1] - tmp_map_tbl[mid][1]);
                    break;
                }
                high = mid - 1;
            }
            else // ==
            {
                tmp = tmp_map_tbl[mid][1] * 10;
                break;
            }
        }
    }
    return tmp;
}


void heater_ctrl(int pwm)
{
    HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_4);

    __HAL_TIM_SET_COMPARE(&htim4, TIM_CHANNEL_4, pwm);
}



void heater_clockrun(int16_t target_temp, int16_t current_temp)  // 0.1°C
{
    // r=10*((float)temp_adc/65535*4.096)/(3.3-(float)temp_adc/65535*4.096);
    static int pwm = 0;
    int16_t delta_pwm = (target_temp - current_temp) * 0.02;

    // 高于45度不再加热
    if ((current_temp > 450) && (delta_pwm > 0))
    {
        delta_pwm = 0;
    }

    pwm += delta_pwm;

    pwm = (pwm > 1000) ? 1000 : pwm;
    pwm = (pwm < 0   ) ? 0    : pwm;

    heater_ctrl(pwm);
}

//pt100
float g_heater_pt100_temperature_map_tbl[][2] = {
        { 92.44, -10 },
        { 92.84, -9 },
        { 93.24, -8 },
        { 93.63, -7 },
        { 94.03, -6 },
        { 94.43, -5 },
        { 94.83, -4 },
        { 95.23, -3 },
        { 95.63, -2 },
        { 96.03, -1 },
        { 100.008, 0 },
        { 100.0475, 0.1 },
        { 100.087, 0.2 },
        { 100.1265, 0.3 },
        { 100.166, 0.4 },
        { 100.2055, 0.5 },
        { 100.245, 0.6 },
        { 100.2845, 0.7 },
        { 100.324, 0.8 },
        { 100.3635, 0.9 },
        { 100.403, 1 },
        { 100.4425, 1.1 },
        { 100.482, 1.2 },
        { 100.5215, 1.3 },
        { 100.561, 1.4 },
        { 100.6005, 1.5 },
        { 100.64, 1.6 },
        { 100.6795, 1.7 },
        { 100.719, 1.8 },
        { 100.7585, 1.9 },
        { 100.798, 2 },
        { 100.8375, 2.1 },
        { 100.877, 2.2 },
        { 100.9165, 2.3 },
        { 100.956, 2.4 },
        { 100.9955, 2.5 },
        { 101.035, 2.6 },
        { 101.0745, 2.7 },
        { 101.114, 2.8 },
        { 101.1535, 2.9 },
        { 101.193, 3 },
        { 101.2325, 3.1 },
        { 101.272, 3.2 },
        { 101.3115, 3.3 },
        { 101.351, 3.4 },
        { 101.3905, 3.5 },
        { 101.43, 3.6 },
        { 101.4695, 3.7 },
        { 101.509, 3.8 },
        { 101.5485, 3.9 },
        { 101.588, 4 },
        { 101.6275, 4.1 },
        { 101.667, 4.2 },
        { 101.7065, 4.3 },
        { 101.746, 4.4 },
        { 101.7855, 4.5 },
        { 101.825, 4.6 },
        { 101.8645, 4.7 },
        { 101.904, 4.8 },
        { 101.9435, 4.9 },
        { 101.983, 5 },
        { 102.0225, 5.1 },
        { 102.062, 5.2 },
        { 102.1015, 5.3 },
        { 102.141, 5.4 },
        { 102.1805, 5.5 },
        { 102.22, 5.6 },
        { 102.2595, 5.7 },
        { 102.299, 5.8 },
        { 102.3385, 5.9 },
        { 102.378, 6 },
        { 102.4175, 6.1 },
        { 102.457, 6.2 },
        { 102.4965, 6.3 },
        { 102.536, 6.4 },
        { 102.5755, 6.5 },
        { 102.615, 6.6 },
        { 102.6545, 6.7 },
        { 102.694, 6.8 },
        { 102.7335, 6.9 },
        { 102.773, 7 },
        { 102.8125, 7.1 },
        { 102.852, 7.2 },
        { 102.8915, 7.3 },
        { 102.931, 7.4 },
        { 102.9705, 7.5 },
        { 103.01, 7.6 },
        { 103.0495, 7.7 },
        { 103.089, 7.8 },
        { 103.1285, 7.9 },
        { 103.168, 8 },
        { 103.2075, 8.1 },
        { 103.247, 8.2 },
        { 103.2865, 8.3 },
        { 103.326, 8.4 },
        { 103.3655, 8.5 },
        { 103.405, 8.6 },
        { 103.4445, 8.7 },
        { 103.484, 8.8 },
        { 103.5235, 8.9 },
        { 103.563, 9 },
        { 103.6025, 9.1 },
        { 103.642, 9.2 },
        { 103.6815, 9.3 },
        { 103.721, 9.4 },
        { 103.7605, 9.5 },
        { 103.8, 9.6 },
        { 103.8395, 9.7 },
        { 103.879, 9.8 },
        { 103.9185, 9.9 },
        { 103.958, 10 },
        { 103.9975, 10.1 },
        { 104.037, 10.2 },
        { 104.0765, 10.3 },
        { 104.116, 10.4 },
        { 104.1555, 10.5 },
        { 104.195, 10.6 },
        { 104.2345, 10.7 },
        { 104.274, 10.8 },
        { 104.3135, 10.9 },
        { 104.353, 11 },
        { 104.3925, 11.1 },
        { 104.432, 11.2 },
        { 104.4715, 11.3 },
        { 104.511, 11.4 },
        { 104.5505, 11.5 },
        { 104.59, 11.6 },
        { 104.6295, 11.7 },
        { 104.669, 11.8 },
        { 104.7085, 11.9 },
        { 104.748, 12 },
        { 104.7875, 12.1 },
        { 104.827, 12.2 },
        { 104.8665, 12.3 },
        { 104.906, 12.4 },
        { 104.9455, 12.5 },
        { 104.985, 12.6 },
        { 105.0245, 12.7 },
        { 105.064, 12.8 },
        { 105.1035, 12.9 },
        { 105.143, 13 },
        { 105.1825, 13.1 },
        { 105.222, 13.2 },
        { 105.2615, 13.3 },
        { 105.301, 13.4 },
        { 105.3405, 13.5 },
        { 105.38, 13.6 },
        { 105.4195, 13.7 },
        { 105.459, 13.8 },
        { 105.4985, 13.9 },
        { 105.538, 14 },
        { 105.5775, 14.1 },
        { 105.617, 14.2 },
        { 105.6565, 14.3 },
        { 105.696, 14.4 },
        { 105.7355, 14.5 },
        { 105.775, 14.6 },
        { 105.8145, 14.7 },
        { 105.854, 14.8 },
        { 105.8935, 14.9 },
        { 105.933, 15 },
        { 105.9725, 15.1 },
        { 106.012, 15.2 },
        { 106.0515, 15.3 },
        { 106.091, 15.4 },
        { 106.1305, 15.5 },
        { 106.17, 15.6 },
        { 106.2095, 15.7 },
        { 106.249, 15.8 },
        { 106.2885, 15.9 },
        { 106.328, 16 },
        { 106.3675, 16.1 },
        { 106.407, 16.2 },
        { 106.4465, 16.3 },
        { 106.486, 16.4 },
        { 106.5255, 16.5 },
        { 106.565, 16.6 },
        { 106.6045, 16.7 },
        { 106.644, 16.8 },
        { 106.6835, 16.9 },
        { 106.723, 17 },
        { 106.7625, 17.1 },
        { 106.802, 17.2 },
        { 106.8415, 17.3 },
        { 106.881, 17.4 },
        { 106.9205, 17.5 },
        { 106.96, 17.6 },
        { 106.9995, 17.7 },
        { 107.039, 17.8 },
        { 107.0785, 17.9 },
        { 107.118, 18 },
        { 107.1575, 18.1 },
        { 107.197, 18.2 },
        { 107.2365, 18.3 },
        { 107.276, 18.4 },
        { 107.3155, 18.5 },
        { 107.355, 18.6 },
        { 107.3945, 18.7 },
        { 107.434, 18.8 },
        { 107.4735, 18.9 },
        { 107.513, 19 },
        { 107.5525, 19.1 },
        { 107.592, 19.2 },
        { 107.6315, 19.3 },
        { 107.671, 19.4 },
        { 107.7105, 19.5 },
        { 107.75, 19.6 },
        { 107.7895, 19.7 },
        { 107.829, 19.8 },
        { 107.8685, 19.9 },
        { 107.908, 20 },
        { 107.9475, 20.1 },
        { 107.987, 20.2 },
        { 108.0265, 20.3 },
        { 108.066, 20.4 },
        { 108.1055, 20.5 },
        { 108.145, 20.6 },
        { 108.1845, 20.7 },
        { 108.224, 20.8 },
        { 108.2635, 20.9 },
        { 108.303, 21 },
        { 108.3425, 21.1 },
        { 108.382, 21.2 },
        { 108.4215, 21.3 },
        { 108.461, 21.4 },
        { 108.5005, 21.5 },
        { 108.54, 21.6 },
        { 108.5795, 21.7 },
        { 108.619, 21.8 },
        { 108.6585, 21.9 },
        { 108.698, 22 },
        { 108.7375, 22.1 },
        { 108.777, 22.2 },
        { 108.8165, 22.3 },
        { 108.856, 22.4 },
        { 108.8955, 22.5 },
        { 108.935, 22.6 },
        { 108.9745, 22.7 },
        { 109.014, 22.8 },
        { 109.0535, 22.9 },
        { 109.093, 23 },
        { 109.1325, 23.1 },
        { 109.172, 23.2 },
        { 109.2115, 23.3 },
        { 109.251, 23.4 },
        { 109.2905, 23.5 },
        { 109.33, 23.6 },
        { 109.3695, 23.7 },
        { 109.409, 23.8 },
        { 109.4485, 23.9 },
        { 109.488, 24 },
        { 109.5275, 24.1 },
        { 109.567, 24.2 },
        { 109.6065, 24.3 },
        { 109.646, 24.4 },
        { 109.6855, 24.5 },
        { 109.725, 24.6 },
        { 109.7645, 24.7 },
        { 109.804, 24.8 },
        { 109.8435, 24.9 },
        { 109.883, 25 },
        { 109.9225, 25.1 },
        { 109.962, 25.2 },
        { 110.0015, 25.3 },
        { 110.041, 25.4 },
        { 110.0805, 25.5 },
        { 110.12, 25.6 },
        { 110.1595, 25.7 },
        { 110.199, 25.8 },
        { 110.2385, 25.9 },
        { 110.278, 26 },
        { 110.3175, 26.1 },
        { 110.357, 26.2 },
        { 110.3965, 26.3 },
        { 110.436, 26.4 },
        { 110.4755, 26.5 },
        { 110.515, 26.6 },
        { 110.5545, 26.7 },
        { 110.594, 26.8 },
        { 110.6335, 26.9 },
        { 110.673, 27 },
        { 110.7125, 27.1 },
        { 110.752, 27.2 },
        { 110.7915, 27.3 },
        { 110.831, 27.4 },
        { 110.8705, 27.5 },
        { 110.91, 27.6 },
        { 110.9495, 27.7 },
        { 110.989, 27.8 },
        { 111.0285, 27.9 },
        { 111.068, 28 },
        { 111.1075, 28.1 },
        { 111.147, 28.2 },
        { 111.1865, 28.3 },
        { 111.226, 28.4 },
        { 111.2655, 28.5 },
        { 111.305, 28.6 },
        { 111.3445, 28.7 },
        { 111.384, 28.8 },
        { 111.4235, 28.9 },
        { 111.463, 29 },
        { 111.5025, 29.1 },
        { 111.542, 29.2 },
        { 111.5815, 29.3 },
        { 111.621, 29.4 },
        { 111.6605, 29.5 },
        { 111.7, 29.6 },
        { 111.7395, 29.7 },
        { 111.779, 29.8 },
        { 111.8185, 29.9 },
        { 111.858, 30 },
        { 111.8975, 30.1 },
        { 111.937, 30.2 },
        { 111.9765, 30.3 },
        { 112.016, 30.4 },
        { 112.0555, 30.5 },
        { 112.095, 30.6 },
        { 112.1345, 30.7 },
        { 112.174, 30.8 },
        { 112.2135, 30.9 },
        { 112.253, 31 },
        { 112.2925, 31.1 },
        { 112.332, 31.2 },
        { 112.3715, 31.3 },
        { 112.411, 31.4 },
        { 112.4505, 31.5 },
        { 112.49, 31.6 },
        { 112.5295, 31.7 },
        { 112.569, 31.8 },
        { 112.6085, 31.9 },
        { 112.648, 32 },
        { 112.6875, 32.1 },
        { 112.727, 32.2 },
        { 112.7665, 32.3 },
        { 112.806, 32.4 },
        { 112.8455, 32.5 },
        { 112.885, 32.6 },
        { 112.9245, 32.7 },
        { 112.964, 32.8 },
        { 113.0035, 32.9 },
        { 113.043, 33 },
        { 113.0825, 33.1 },
        { 113.122, 33.2 },
        { 113.1615, 33.3 },
        { 113.201, 33.4 },
        { 113.2405, 33.5 },
        { 113.28, 33.6 },
        { 113.3195, 33.7 },
        { 113.359, 33.8 },
        { 113.3985, 33.9 },
        { 113.438, 34 },
        { 113.4775, 34.1 },
        { 113.517, 34.2 },
        { 113.5565, 34.3 },
        { 113.596, 34.4 },
        { 113.6355, 34.5 },
        { 113.675, 34.6 },
        { 113.7145, 34.7 },
        { 113.754, 34.8 },
        { 113.7935, 34.9 },
        { 113.833, 35 },
        { 113.8725, 35.1 },
        { 113.912, 35.2 },
        { 113.9515, 35.3 },
        { 113.991, 35.4 },
        { 114.0305, 35.5 },
        { 114.07, 35.6 },
        { 114.1095, 35.7 },
        { 114.149, 35.8 },
        { 114.1885, 35.9 },
        { 114.228, 36 },
        { 114.2675, 36.1 },
        { 114.307, 36.2 },
        { 114.3465, 36.3 },
        { 114.386, 36.4 },
        { 114.4255, 36.5 },
        { 114.465, 36.6 },
        { 114.5045, 36.7 },
        { 114.544, 36.8 },
        { 114.5835, 36.9 },
        { 114.623, 37 },
        { 114.6625, 37.1 },
        { 114.702, 37.2 },
        { 114.7415, 37.3 },
        { 114.781, 37.4 },
        { 114.8205, 37.5 },
        { 114.86, 37.6 },
        { 114.8995, 37.7 },
        { 114.939, 37.8 },
        { 114.9785, 37.9 },
        { 115.018, 38 },
        { 115.0575, 38.1 },
        { 115.097, 38.2 },
        { 115.1365, 38.3 },
        { 115.176, 38.4 },
        { 115.2155, 38.5 },
        { 115.255, 38.6 },
        { 115.2945, 38.7 },
        { 115.334, 38.8 },
        { 115.3735, 38.9 },
        { 115.413, 39 },
        { 115.4525, 39.1 },
        { 115.492, 39.2 },
        { 115.5315, 39.3 },
        { 115.571, 39.4 },
        { 115.6105, 39.5 },
        { 115.65, 39.6 },
        { 115.6895, 39.7 },
        { 115.729, 39.8 },
        { 115.7685, 39.9 },
        { 115.808, 40 },
        { 115.8475, 40.1 },
        { 115.887, 40.2 },
        { 115.9265, 40.3 },
        { 115.966, 40.4 },
        { 116.0055, 40.5 },
        { 116.045, 40.6 },
        { 116.0845, 40.7 },
        { 116.124, 40.8 },
        { 116.1635, 40.9 },
        { 116.203, 41 },
        { 116.2425, 41.1 },
        { 116.282, 41.2 },
        { 116.3215, 41.3 },
        { 116.361, 41.4 },
        { 116.4005, 41.5 },
        { 116.44, 41.6 },
        { 116.4795, 41.7 },
        { 116.519, 41.8 },
        { 116.5585, 41.9 },
        { 116.598, 42 },
        { 116.6375, 42.1 },
        { 116.677, 42.2 },
        { 116.7165, 42.3 },
        { 116.756, 42.4 },
        { 116.7955, 42.5 },
        { 116.835, 42.6 },
        { 116.8745, 42.7 },
        { 116.914, 42.8 },
        { 116.9535, 42.9 },
        { 116.993, 43 },
        { 117.0325, 43.1 },
        { 117.072, 43.2 },
        { 117.1115, 43.3 },
        { 117.151, 43.4 },
        { 117.1905, 43.5 },
        { 117.23, 43.6 },
        { 117.2695, 43.7 },
        { 117.309, 43.8 },
        { 117.3485, 43.9 },
        { 117.388, 44 },
        { 117.4275, 44.1 },
        { 117.467, 44.2 },
        { 117.5065, 44.3 },
        { 117.546, 44.4 },
        { 117.5855, 44.5 },
        { 117.625, 44.6 },
        { 117.6645, 44.7 },
        { 117.704, 44.8 },
        { 117.7435, 44.9 },
        { 117.783, 45 },
        { 117.8225, 45.1 },
        { 117.862, 45.2 },
        { 117.9015, 45.3 },
        { 117.941, 45.4 },
        { 117.9805, 45.5 },
        { 118.02, 45.6 },
        { 118.0595, 45.7 },
        { 118.099, 45.8 },
        { 118.1385, 45.9 },
        { 118.178, 46 },
        { 118.2175, 46.1 },
        { 118.257, 46.2 },
        { 118.2965, 46.3 },
        { 118.336, 46.4 },
        { 118.3755, 46.5 },
        { 118.415, 46.6 },
        { 118.4545, 46.7 },
        { 118.494, 46.8 },
        { 118.5335, 46.9 },
        { 118.573, 47 },
        { 118.6125, 47.1 },
        { 118.652, 47.2 },
        { 118.6915, 47.3 },
        { 118.731, 47.4 },
        { 118.7705, 47.5 },
        { 118.81, 47.6 },
        { 118.8495, 47.7 },
        { 118.889, 47.8 },
        { 118.9285, 47.9 },
        { 118.968, 48 },
        { 119.0075, 48.1 },
        { 119.047, 48.2 },
        { 119.0865, 48.3 },
        { 119.126, 48.4 },
        { 119.1655, 48.5 },
        { 119.205, 48.6 },
        { 119.2445, 48.7 },
        { 119.284, 48.8 },
        { 119.3235, 48.9 },
        { 119.363, 49 },
        { 119.4025, 49.1 },
        { 119.442, 49.2 },
        { 119.4815, 49.3 },
        { 119.521, 49.4 },
        { 119.5605, 49.5 },
        { 119.6, 49.6 },
        { 119.6395, 49.7 },
        { 119.679, 49.8 },
        { 119.7185, 49.9 },
        { 119.758, 50 },
        { 119.7975, 50.1 },
        { 119.837, 50.2 },
        { 119.8765, 50.3 },
        { 119.916, 50.4 },
        { 119.9555, 50.5 },
        { 119.995, 50.6 },
        { 120.0345, 50.7 },
        { 120.074, 50.8 },
        { 120.1135, 50.9 },
        { 120.153, 51 },
        { 120.1925, 51.1 },
        { 120.232, 51.2 },
        { 120.2715, 51.3 },
        { 120.311, 51.4 },
        { 120.3505, 51.5 },
        { 120.39, 51.6 },
        { 120.4295, 51.7 },
        { 120.469, 51.8 },
        { 120.5085, 51.9 },
        { 120.548, 52 },
        { 120.5875, 52.1 },
        { 120.627, 52.2 },
        { 120.6665, 52.3 },
        { 120.706, 52.4 },
        { 120.7455, 52.5 },
        { 120.785, 52.6 },
        { 120.8245, 52.7 },
        { 120.864, 52.8 },
        { 120.9035, 52.9 },
        { 120.943, 53 },
        { 120.9825, 53.1 },
        { 121.022, 53.2 },
        { 121.0615, 53.3 },
        { 121.101, 53.4 },
        { 121.1405, 53.5 },
        { 121.18, 53.6 },
        { 121.2195, 53.7 },
        { 121.259, 53.8 },
        { 121.2985, 53.9 },
        { 121.338, 54 },
        { 121.3775, 54.1 },
        { 121.417, 54.2 },
        { 121.4565, 54.3 },
        { 121.496, 54.4 },
        { 121.5355, 54.5 },
        { 121.575, 54.6 },
        { 121.6145, 54.7 },
        { 121.654, 54.8 },
        { 121.6935, 54.9 },
        { 121.733, 55 },
        { 121.7725, 55.1 },
        { 121.812, 55.2 },
        { 121.8515, 55.3 },
        { 121.891, 55.4 },
        { 121.9305, 55.5 },
        { 121.97, 55.6 },
        { 122.0095, 55.7 },
        { 122.049, 55.8 },
        { 122.0885, 55.9 },
        { 122.128, 56 },
        { 122.1675, 56.1 },
        { 122.207, 56.2 },
        { 122.2465, 56.3 },
        { 122.286, 56.4 },
        { 122.3255, 56.5 },
        { 122.365, 56.6 },
        { 122.4045, 56.7 },
        { 122.444, 56.8 },
        { 122.4835, 56.9 },
        { 122.523, 57 },
        { 122.5625, 57.1 },
        { 122.602, 57.2 },
        { 122.6415, 57.3 },
        { 122.681, 57.4 },
        { 122.7205, 57.5 },
        { 122.76, 57.6 },
        { 122.7995, 57.7 },
        { 122.839, 57.8 },
        { 122.8785, 57.9 },
        { 122.918, 58 },
        { 122.9575, 58.1 },
        { 122.997, 58.2 },
        { 123.0365, 58.3 },
        { 123.076, 58.4 },
        { 123.1155, 58.5 },
        { 123.155, 58.6 },
        { 123.1945, 58.7 },
        { 123.234, 58.8 },
        { 123.2735, 58.9 },
        { 123.313, 59 },
        { 123.3525, 59.1 },
        { 123.392, 59.2 },
        { 123.4315, 59.3 },
        { 123.471, 59.4 },
        { 123.5105, 59.5 },
        { 123.55, 59.6 },
        { 123.5895, 59.7 },
        { 123.629, 59.8 },
        { 123.6685, 59.9 },
        { 123.708, 60 }
};


float heater_pt100_get_temperature(float resistance)
{
    uint32_t count = sizeof(g_heater_pt100_temperature_map_tbl)/sizeof(g_heater_pt100_temperature_map_tbl[0]);

    return heater_pt100_get_temperature_by_map(resistance, g_heater_pt100_temperature_map_tbl, count);
}

